name: Build OpenWrt for Tenda RX12L Pro

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update and install
        run: |
          sudo apt-get update
          sudo apt-get install -y --fix-missing build-essential ccache git libncurses-dev python3-setuptools swig libssl-dev gettext rsync gawk unzip libncurses6 libncursesw6

      - name: Clone OpenWrt
        run: git clone --depth 1 -b v23.05.5 https://github.com/openwrt/openwrt.git openwrt

      - name: Pre-build check
        run: |
          cd openwrt
          echo "=== Checking syntax with dry-run ==="
          make --debug=basic -n target/linux/compile 2>&1 | head -30
          echo "=== Checking device variables ==="
          make -p 2>&1 | grep -i "tenda\|rx12l" | head -10

      - name: Copy DTS file
        run: cp patches/dts/mt7981b-tenda-rx12l-pro.dts openwrt/target/linux/mediatek/dts/

      - name: Apply patches
        run: |
          cd openwrt
          sed -i 's/yuncore,ax835)/yuncore,ax835| tenda,rx12l-pro)/g' target/linux/mediatek/filogic/base-files/etc/board.d/02_network
          sed -i 's/yuncore,ax835)/yuncore,ax835| tenda,rx12l-pro)/g' target/linux/mediatek/filogic/base-files/lib/upgrade/platform.sh
          cat ../patches/filogic-addition.mk >> target/linux/mediatek/image/filogic.mk

      - name: Configure
        run: |
          cd openwrt
          make defconfig
          echo CONFIG_TARGET_mediatek=y >> .config
          echo CONFIG_TARGET_mediatek_filogic=y >> .config
          echo CONFIG_TARGET_mediatek_filogic_Default=y >> .config
          echo CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_tenda_rx12l_pro=y >> .config
          make defconfig

      - name: Pre-build verify
        run: |
          cd openwrt/target/linux
          make --debug=basic -n 2>&1 | head -20
          make -p 2>&1 | grep -i "tenda\|rx12l" | head -10
          make --debug=verbose -n config 2>&1 | head -20

      - name: Build
        run: |
          cd openwrt && make -j$(nproc)

      - name: Debug list output directory
        run: |
          ls -la openwrt/bin/targets/mediatek/filogic/ || echo "Directory not found"
          find openwrt/bin -name "*.bin" -o -name "*.trx" | head -20

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware
          path: openwrt/bin/targets/mediatek/filogic/
